<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <!-- Couleur du th√®me (PWA) -->
  <meta name="theme-color" content="#111827">

  <!-- PWA -->
  <link rel="manifest" href="/static/manifest.webmanifest">
  <link rel="apple-touch-icon" href="/static/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Devis SBBM">

  <title>Devis SBBM - Formulaire</title>
  <link rel="stylesheet" href="/static/style.css">
  <link rel="icon" href="/static/favicon.ico">

  <style>
    .hidden { display: none; }

    .zone-block {
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 6px;
      margin-top: 10px;
      background: #fff;
    }
    .zone-title { font-weight: bold; margin-bottom: 8px; }

    .grid2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px 10px;
    }

    .table-like {
      width: 100%;
      border-collapse: collapse;
      margin-top: 5px;
    }
    .table-like th,
    .table-like td {
      border: 1px solid #ccc;
      padding: 4px;
      font-size: 12px;
    }

    .btn-small { font-size: 12px; padding: 3px 8px; margin-top: 4px; }
    .radio-group { display: flex; gap: 12px; flex-wrap: wrap; }
    .hint { font-size: 11px; color: #555; }

    /* ---------- Auto-compl√©tion clients ---------- */
    .client-search-wrapper {
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .client-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      z-index: 20;
      background: #ffffff;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      max-height: 220px;
      overflow-y: auto;
      margin-top: 2px;
      box-shadow: 0 10px 20px rgba(15, 23, 42, 0.18);
      font-size: 12px;
    }

    .client-result-item {
      padding: 4px 8px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      gap: 6px;
    }

    .client-result-item:hover {
      background: #e5f3ff;
    }

    .client-result-code {
      font-weight: 600;
      color: #111827;
    }

    .client-result-name {
      color: #4b5563;
      flex: 1;
      text-align: right;
    }

    /* ---------- MODAL NOUVEAU CLIENT ---------- */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .modal-overlay.hidden {
      display: none;
    }
    .modal-card {
      background: #ffffff;
      padding: 16px 18px;
      border-radius: 10px;
      width: 320px;
      box-shadow: 0 10px 30px rgba(15,23,42,0.25);
      font-size: 13px;
    }
    .modal-card h3 {
      margin: 0 0 10px;
      font-size: 14px;
      font-weight: 600;
    }
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 10px;
    }
    .modal-status {
      margin-top: 8px;
      font-size: 12px;
      color: #047857;
    }
  </style>
</head>
<body>
  <div class="page">
    {% if user_code_commercial %}
    <div class="user-bar">
      <div class="user-bar-left">
        Connect√© : <strong>{{ user_code_commercial }}</strong>
        {% if user_nom %} ({{ user_nom }}){% endif %}
      </div>
      <div class="user-bar-right">
        <a href="/logout" class="user-bar-link">D√©connexion</a>
      </div>
    </div>
    {% endif %}

    <header class="header">
      <div class="header-left">
        <div class="societe">SOCI√âT√â DE B√ÇTIMENTS ET B√âTON MOUL√â ‚ÄúSBBM‚Äù</div>
        <div class="coord">
          Lot 410 Sidi Ghanem Q.I Marrakech<br>
          T√©l : +212 5 24 33 54 48 ‚Ä¢ Email : sbbmdga@gmail.com
        </div>
      </div>
      <div class="header-right">
        <div class="logo-box">
          <img src="/static/logo_sbbm.jpg" alt="Logo SBBM">
        </div>
      </div>
    </header>

    <div class="title">Formulaire de saisie ‚Äî G√©n√©ration Devis</div>

    <form class="form" action="/generate" method="post" enctype="multipart/form-data">
      <!-- ================== Infos client & devis ================== -->
      <div class="top-grid">
        <div class="card">
          <div class="card-title">INFORMATIONS CLIENT</div>
          <div class="grid2">

            <!-- Code client affich√© (lecture seule) -->
            <div class="lbl">Code client :</div>
            <div>
              <input class="inp" type="text" id="code_client_display" readonly>
            </div>

            <!-- Recherche client (code ou nom) -->
            <div class="lbl">Client :</div>
            <div class="client-search-wrapper">
              <div style="display:flex; align-items:center; gap:8px;">
                <input class="inp"
                       type="text"
                       id="client_search"
                       autocomplete="off"
                       placeholder="Tapez un code ou un nom de client...">

                <button type="button" class="btn btn-small" id="btn_new_client">
                  + Nouveau client
                </button>
              </div>
              <div id="client_results" class="client-results hidden"></div>
            </div>

            <!-- Champs r√©els envoy√©s au backend -->
            <input type="hidden" name="code_client" id="code_client_hidden" value="{{ code_client or '' }}">
            <input type="hidden" name="client" id="client_hidden" value="{{ client or '' }}">

            <div class="lbl">Adresse chantier :</div>
            <div>
              <input class="inp" type="text" name="chantier" value="{{ chantier or '' }}">
            </div>

            <div class="lbl">Niveau :</div>
            <div>
              <input class="inp" type="text" name="niveau" value="{{ niveau or '' }}">
            </div>

            <div class="lbl">N¬∞ affaire :</div>
            <div>
              <input class="inp" type="text" name="affaire" value="{{ affaire or '' }}">
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-title">INFORMATIONS DEVIS</div>
          <div class="grid2">
            <label class="lbl">Date devis</label>
            <input class="inp" name="date_devis" value="{{ today }}" />

            <label class="lbl">R√©f devis *</label>
            <input class="inp" type="text" name="ref_devis" required value="{{ next_ref_devis or '' }}" readonly />

            <label class="lbl">Mode livraison</label>
            <select class="inp" name="mode_livraison">
              <option value="SOLO">SOLO</option>
              <option value="REMORQUE">REMORQUE</option>
            </select>

            <label class="lbl">Validit√©</label>
            <input class="inp" name="validite" value="30 jours" />
          </div>
        </div>
      </div>

      <!-- ================== Commercial & remises ================== -->
      <div class="card" style="margin-top:12px;">
        <div class="card-title">COMMERCIAL & REMISES</div>
        <div class="grid2">
          <!-- Code commercial -->
          <label class="lbl">Code commercial</label>
          <div>
            {% if user_code_commercial %}
              <!-- Champ cach√© pour le backend -->
              <input type="hidden"
                     name="code_commercial"
                     id="code_commercial"
                     value="{{ user_code_commercial }}">
              <!-- Affichage lecture seule -->
              <input class="inp" type="text"
                     value="{{ user_code_commercial }} - {{ user_nom or '' }}"
                     readonly>
            {% else %}
              <!-- Fallback si pas de login -->
              <select class="inp" name="code_commercial" id="code_commercial">
                {% for code, nom in liste_commerciaux.items() %}
                <option value="{{ code }}">{{ code }} - {{ nom }}</option>
                {% endfor %}
              </select>
            {% endif %}
          </div>

          <!-- Nom commercial -->
          <label class="lbl">Nom commercial</label>
          <div>
            <input class="inp"
                   id="nom_commercial"
                   name="nom_commercial"
                   value="{{ user_nom or '' }}"
                   readonly />
          </div>

          <!-- Remise poutrelles -->
          <label class="lbl">Remise poutrelles (%)</label>
          <div>
            <input class="inp"
                   type="number"
                   step="0.01"
                   name="remise_poutrelle"
                   value="30" />
          </div>

          <!-- Remise hourdis -->
          <label class="lbl">Remise hourdis (%)</label>
          <div>
            <input class="inp"
                   type="number"
                   step="0.01"
                   name="remise_hourdis"
                   value="25" />
          </div>

          <!-- Prix CT -->
          <label class="lbl">Prix unitaire contr√¥le technique (DH)</label>
          <div>
            <input class="inp"
                   type="number"
                   step="0.01"
                   name="prix_ct"
                   value="3" />
          </div>

          <!-- Prix treillis -->
          <label class="lbl">Prix unitaire treillis soud√©s (DH)</label>
          <div>
            <input class="inp"
                   type="number"
                   step="1"
                   name="prix_treillis"
                   value="160" />
          </div>
        </div>
      </div>

      <!-- ================== Choix mode de saisie ================== -->
      <div class="card" style="margin-top:12px;">
        <div class="card-title">MODE DE SAISIE DES QUANTIT√âS</div>
        <div class="radio-group">
          <label>
            <input type="radio" name="saisie_mode" value="progiciel" id="mode_progiciel" checked>
            √Ä partir du fichier progiciel (CSV)
          </label>
          <label>
            <input type="radio" name="saisie_mode" value="manuel" id="mode_manuel">
            Saisie manuelle des poutrelles / hourdis / CT / treillis
          </label>
        </div>

        <!-- Zone fichier progiciel -->
        <div id="zone_progiciel" class="zone-block" style="margin-top:10px;">
          <div class="zone-title">FICHIER PROGICIEL (CSV)</div>
          <div class="grid2">
            <div class="lbl">Importer le CSV</div>
            <input class="inp" type="file" name="fichier_progiciel" accept=".csv,text/csv" />
            <div class="hint">Si vide, le syst√®me g√©n√®re un devis sans quantit√©s.</div>
          </div>
        </div>

        <!-- Zone saisie manuelle -->
        <div id="zone_manuel" class="zone-block hidden" style="margin-top:10px;">
          <div class="zone-title">SAISIE MANUELLE</div>

          <!-- POUTRELLES -->
          <div>
            <div class="zone-title">Poutrelles</div>
            <table class="table-like" id="table_poutrelles">
              <thead>
                <tr>
                  <th>Type</th>
                  <th>Longueur (ml)</th>
                  <th>Nb √©triers / poutrelle</th>
                  <th>Nombre de poutrelles</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="tbody_poutrelles"></tbody>
            </table>
            <button type="button" class="btn btn-small" id="btn_add_poutrelle">
              + Ajouter poutrelle
            </button>
          </div>

          <!-- HOURDIS -->
          <div style="margin-top:10px;">
            <div class="zone-title">Hourdis</div>
            <table class="table-like" id="table_hourdis">
              <thead>
                <tr>
                  <th>Type hourdis</th>
                  <th>Quantit√© (unit√©s)</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="tbody_hourdis"></tbody>
            </table>
            <button type="button" class="btn btn-small" id="btn_add_hourdis">
              + Ajouter hourdis
            </button>
          </div>

          <!-- CT & TREILLIS -->
          <div style="margin-top:10px;" class="grid2">
            <div>
              <label class="lbl">Surface contr√¥le technique (m¬≤)</label>
              <input class="inp" type="number" step="0.01" name="surface_ct_manual" value="0">
            </div>
            <div>
              <label class="lbl">Nombre de treillis soud√©s</label>
              <input class="inp" type="number" step="1" name="nb_treillis_manual" value="0">
            </div>
          </div>
        </div>
      </div>

      <!-- ================== Transport ================== -->
      <div class="card" style="margin-top:12px;">
        <div class="card-title">TRANSPORT</div>

        <div class="grid2">
          <div>
            <label class="lbl">Mode transport</label>
            <select class="inp" name="mode_transport" id="mode_transport">
              <option value="depart">D√©part usine</option>
              <option value="rendu">Rendu chantier</option>
            </select>
          </div>

          <div id="distance_container">
            <label class="lbl">Distance (km)</label>
            <input class="inp" id="distance_km" name="distance_km" type="number" step="0.1" value="0" />
            <div class="hint">Obligatoire pour le calcul automatique du transport rendu chantier.</div>
          </div>
        </div>

        <div>
          <label class="lbl">Mode de calcul du transport</label>
          <div class="radio-group">
            <label>
              <input type="radio" name="transport_mode" value="auto" id="transport_auto" checked>
              Calcul automatique
            </label>
            <label>
              <input type="radio" name="transport_mode" value="manuel" id="transport_manuel">
              Saisie manuelle
            </label>
          </div>
        </div>

        <!-- Zone transport manuel -->
        <div id="zone_transport_manuel" class="zone-block hidden">
          <div class="zone-title">Transport saisi manuellement</div>
          <div class="grid2">
            <div>
              <label class="lbl">Transport poutrelles (DH/ml)</label>
              <input class="inp" type="number" step="0.01"
                     name="transport_prix_poutrelle_manuel" value="0">
            </div>
            <div>
              <label class="lbl">Transport hourdis (DH/unit√©)</label>
              <input class="inp" type="number" step="0.01"
                     name="transport_prix_hourdis_manuel" value="0">
            </div>
          </div>
        </div>

        <!-- Zone info transport auto -->
        <div id="zone_transport_auto_info" class="zone-block">
          <div class="zone-title">Transport automatique (simulation)</div>
          <div class="hint" id="hint_transport_auto">
            Le prix calcul√© par le syst√®me sera affich√© ici apr√®s la lecture du CSV ou la saisie manuelle.
          </div>
        </div>
      </div>

      <!-- ================== Boutons ================== -->
      <div style="display:flex; gap:10px; margin-top:14px;">
        <button class="btn" type="submit">G√©n√©rer le devis</button>
        <a class="btn btn-secondary" href="/devis/form">R√©initialiser</a>
      </div>
      <div class="actions-top" style="margin-bottom:10px;">
        <a class="btn" href="/devis/historique">Historique des devis</a>
      </div>
    </form>
  </div>

  <!-- ========== MODAL NOUVEAU CLIENT ========== -->
  <div id="modal_new_client" class="modal-overlay hidden">
    <div class="modal-card">
      <h3>Nouveau client</h3>
      <form id="form_new_client">
        <div class="grid2" style="margin-top:8px;">
          <div class="lbl">Code client :</div>
          <div>
            <input class="inp" type="text" id="new_client_code" autocomplete="off">
          </div>

          <div class="lbl">Nom client :</div>
          <div>
            <input class="inp" type="text" id="new_client_nom" autocomplete="off">
          </div>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn btn-small btn-secondary" id="btn_cancel_new_client">
            Annuler
          </button>
          <button type="submit" class="btn btn-small">
            Enregistrer
          </button>
        </div>

        <div id="new_client_status" class="modal-status"></div>
      </form>
    </div>
  </div>

  <!-- ========== SCRIPTS ========== -->
  <script>
    // --- Remplir automatiquement le nom du commercial ---
    (function () {
      const selectCode = document.getElementById("code_commercial");
      const inputNom = document.getElementById("nom_commercial");

      const mappingCommerciaux = {
        {% for code, nom in liste_commerciaux.items() %}
        "{{ code }}": "{{ nom }}"{% if not loop.last %},{% endif %}
        {% endfor %}
      };

      function updateNomCommercial() {
        const code = selectCode.value;
        inputNom.value = mappingCommerciaux[code] || "";
      }

      // üîπ Si le commercial n'est PAS fig√© par le login,
      // alors on laisse le user choisir et on met le nom √† jour.
      if (selectCode && !selectCode.disabled && selectCode.tagName === "SELECT") {
        selectCode.addEventListener("change", updateNomCommercial);
        updateNomCommercial();
      }
    })();

    // --- Gestion mode de saisie progiciel / manuel ---
    (function () {
      const radioProgiciel = document.getElementById("mode_progiciel");
      const radioManuel = document.getElementById("mode_manuel");
      const zoneProgiciel = document.getElementById("zone_progiciel");
      const zoneManuel = document.getElementById("zone_manuel");

      function refreshModeSaisie() {
        if (radioProgiciel.checked) {
          zoneProgiciel.classList.remove("hidden");
          zoneManuel.classList.add("hidden");
        } else {
          zoneProgiciel.classList.add("hidden");
          zoneManuel.classList.remove("hidden");
        }
      }

      radioProgiciel.addEventListener("change", refreshModeSaisie);
      radioManuel.addEventListener("change", refreshModeSaisie);
      refreshModeSaisie();
    })();

    // --- Ajout dynamique des lignes de poutrelles ---
    (function () {
      const tbody = document.getElementById("tbody_poutrelles");
      const btnAdd = document.getElementById("btn_add_poutrelle");

      function addRowPoutrelle() {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>
            <select class="inp" name="manual_pout_type">
              <option value="">-- Type --</option>
              <option value="113">113</option>
              <option value="114">114</option>
              <option value="115">115</option>
              <option value="135">135</option>
              <option value="157">157</option>
            </select>
          </td>
          <td><input class="inp" name="manual_pout_longueur" type="number" step="0.01" value="0"></td>
          <td><input class="inp" name="manual_pout_etrier" type="number" step="1" value="0"></td>
          <td><input class="inp" name="manual_pout_nombre" type="number" step="1" value="0"></td>
          <td><button type="button" class="btn btn-small btn-danger">X</button></td>
        `;
        tr.querySelector("button").addEventListener("click", () => tr.remove());
        tbody.appendChild(tr);
      }

      btnAdd.addEventListener("click", addRowPoutrelle);
      addRowPoutrelle();
    })();

    // --- Ajout dynamique des lignes d'hourdis ---
    (function () {
      const tbody = document.getElementById("tbody_hourdis");
      const btnAdd = document.getElementById("btn_add_hourdis");

      function addRowHourdis() {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>
            <select class="inp" name="manual_hourdis_type">
              <option value="">-- Type hourdis --</option>
              <option value="H8">H8</option>
              <option value="H12">H12</option>
              <option value="H16">H16</option>
              <option value="H20">H20</option>
              <option value="H25">H25</option>
              <option value="H30">H30</option>
            </select>
          </td>
          <td><input class="inp" name="manual_hourdis_nombre" type="number" step="1" value="0"></td>
          <td><button type="button" class="btn btn-small btn-danger">X</button></td>
        `;
        tr.querySelector("button").addEventListener("click", () => tr.remove());
        tbody.appendChild(tr);
      }

      btnAdd.addEventListener("click", addRowHourdis);
      addRowHourdis();
    })();

    // --- Transport auto / manuel + simulation ---
    (function () {
      const modeTransport = document.getElementById("mode_transport");
      const radioAuto = document.getElementById("transport_auto");
      const radioManuel = document.getElementById("transport_manuel");
      const zoneManuel = document.getElementById("zone_transport_manuel");
      const zoneAutoInfo = document.getElementById("zone_transport_auto_info");
      const hintAuto = document.getElementById("hint_transport_auto");
      const distanceInput = document.getElementById("distance_km");
      const distanceContainer = document.getElementById("distance_container");

      function refreshTransportUI() {
        const modeTr = modeTransport.value;
        const modeCalc = radioAuto.checked ? "auto" : "manuel";

        if (modeTr === "depart") {
          zoneManuel.classList.add("hidden");
          zoneAutoInfo.classList.add("hidden");
          distanceContainer.classList.add("hidden");
        } else {
          distanceContainer.classList.remove("hidden");
          if (modeCalc === "auto") {
            zoneManuel.classList.add("hidden");
            zoneAutoInfo.classList.remove("hidden");
          } else {
            zoneManuel.classList.remove("hidden");
            zoneAutoInfo.classList.remove("hidden");
          }
        }
      }

      modeTransport.addEventListener("change", () => {
        refreshTransportUI();
        simulateTransport();
      });
      radioAuto.addEventListener("change", () => {
        refreshTransportUI();
        simulateTransport();
      });
      radioManuel.addEventListener("change", refreshTransportUI);

      async function simulateTransport() {
        if (modeTransport.value !== "rendu" || !radioAuto.checked) {
          hintAuto.textContent =
            "Le transport automatique est affich√© seulement en mode 'rendu chantier'.";
          return;
        }

        const dist = parseFloat(distanceInput.value || "0");
        if (isNaN(dist) || dist <= 0) {
          hintAuto.textContent = "Distance invalide ou nulle, pas de calcul de transport.";
          return;
        }
        const body = {
          distance_km: dist,
          mode_transport: modeTransport.value,
          transport_mode: "auto",
          transport_prix_poutrelle_manuel: 0,
          transport_prix_hourdis_manuel: 0
        };
        try {
          const resp = await fetch("/simulate-transport", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
          });
          if (!resp.ok) {
            hintAuto.textContent = "Erreur lors du calcul de transport.";
            return;
          }
          const data = await resp.json();
          const totalAuto = data.transport_total_auto || 0;
          const trMl = data.transport_par_ml_auto || 0;
          const trH = data.transport_par_hourdis_auto || 0;

          if (totalAuto > 0) {
            hintAuto.textContent =
              "Prix calcul√© par le syst√®me : " +
              totalAuto.toFixed(2) +
              " DH (pour info). " +
              "Soit " +
              trMl.toFixed(3) +
              " DH/ml de poutrelle et " +
              trH.toFixed(3) +
              " DH/unit√© d'hourdis.";
          } else {
            hintAuto.textContent =
              "Aucun transport calcul√© (poutrelles / hourdis vides ?).";
          }
        } catch (e) {
          hintAuto.textContent = "Erreur r√©seau / simulate-transport.";
        }
      }

      if (distanceInput) {
        distanceInput.addEventListener("change", simulateTransport);
        distanceInput.addEventListener("blur", simulateTransport);
      }

      refreshTransportUI();
    })();

    // --- Service worker PWA ---
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("/static/service-worker.js")
          .then(reg => console.log("ServiceWorker OK", reg.scope))
          .catch(err => console.log("Erreur ServiceWorker :", err));
      });
    }

    // --- Modal "+ Nouveau client" (POST /api/clients) ---
    (function () {
      const btnOpen       = document.getElementById("btn_new_client");
      const modal         = document.getElementById("modal_new_client");
      const form          = document.getElementById("form_new_client");
      const btnCancel     = document.getElementById("btn_cancel_new_client");
      const inputMainCode = document.getElementById("code_client_hidden");
      const inputMainNom  = document.getElementById("client_hidden");
      const searchInput   = document.getElementById("client_search");
      const inputCode     = document.getElementById("new_client_code");
      const inputNom      = document.getElementById("new_client_nom");
      const statusSpan    = document.getElementById("new_client_status");
      const codeDisplay   = document.getElementById("code_client_display");

      function openModal() {
        inputCode.value = (inputMainCode.value || "").trim();
        inputNom.value  = (inputMainNom.value  || "").trim();
        statusSpan.textContent = "";
        modal.classList.remove("hidden");
        inputCode.focus();
      }
      function closeModal() {
        modal.classList.add("hidden");
      }

      btnOpen.addEventListener("click", openModal);
      btnCancel.addEventListener("click", e => {
        e.preventDefault();
        closeModal();
      });

      modal.addEventListener("click", e => {
        if (e.target === modal) closeModal();
      });

      form.addEventListener("submit", async e => {
        e.preventDefault();
        const code = inputCode.value.trim();
        const nom  = inputNom.value.trim();

        if (!code || !nom) {
          statusSpan.textContent = "Code client et nom client sont obligatoires.";
          return;
        }

        try {
          const resp = await fetch("/api/clients", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ code_client: code, nom_client: nom }),
          });

          if (!resp.ok) {
            let msg = "Erreur lors de la cr√©ation du client.";
            try {
              const err = await resp.json();
              if (err && err.detail) msg = err.detail;
            } catch (_) {}
            statusSpan.textContent = msg;
            return;
          }

          const data = await resp.json();
          const finalCode = data.code_client || code;
          const finalNom  = data.nom_client  || nom;

          // Remplir champs cach√©s + affichage
          inputMainCode.value = finalCode;
          inputMainNom.value  = finalNom;
          codeDisplay.value   = finalCode;
          searchInput.value   = finalCode + " - " + finalNom;

          if (data.status === "exists") {
            statusSpan.textContent = "Client d√©j√† existant, champs remplis automatiquement.";
          } else {
            statusSpan.textContent = "Client cr√©√© avec succ√®s.";
          }

          setTimeout(closeModal, 500);
        } catch (err) {
          console.error(err);
          statusSpan.textContent = "Erreur r√©seau lors de l'appel √† /api/clients.";
        }
      });
    })();

    // --- Auto-compl√©tion clients (GET /api/clients?q=...) ---
    (function () {
      const searchInput   = document.getElementById("client_search");    // champ visible
      const resultsBox    = document.getElementById("client_results");   // liste r√©sultats
      const codeInput     = document.getElementById("code_client_hidden");
      const nomInput      = document.getElementById("client_hidden");
      const codeDisplay   = document.getElementById("code_client_display");

      if (!searchInput || !resultsBox || !codeInput || !nomInput) {
        return;
      }

      // Initialisation √† partir des valeurs backend (si d√©j√† connues)
      (function initFromBackend() {
        const code = codeInput.value.trim();
        const nom  = nomInput.value.trim();
        if (code) codeDisplay.value = code;
        if (code && nom) {
          searchInput.value = code + " - " + nom;
        } else if (nom) {
          searchInput.value = nom;
        }
      })();

      let lastQuery = "";
      let timerId = null;

      function clearResults() {
        resultsBox.innerHTML = "";
        resultsBox.classList.add("hidden");
      }

      function fillClient(code, nom) {
        codeInput.value = code || "";
        nomInput.value  = nom || "";
        codeDisplay.value = code || "";

        if (code && nom) {
          searchInput.value = code + " - " + nom;
        } else if (nom) {
          searchInput.value = nom;
        } else {
          searchInput.value = code || "";
        }

        clearResults();
      }

      function renderResults(list) {
        if (!list || list.length === 0) {
          clearResults();
          return;
        }
        const itemsHtml = list.map(c => {
          const code = c.code_client || "";
          const nom  = c.nom_client || "";
          return `
            <div class="client-result-item"
                 data-code="${code.replace(/"/g, '&quot;')}"
                 data-nom="${nom.replace(/"/g, '&quot;')}">
              <span class="client-result-code">${code}</span>
              <span class="client-result-name">${nom}</span>
            </div>
          `;
        }).join("");

        resultsBox.innerHTML = itemsHtml;
        resultsBox.classList.remove("hidden");

        resultsBox.querySelectorAll(".client-result-item").forEach(el => {
          el.addEventListener("click", () => {
            const code = el.getAttribute("data-code") || "";
            const nom  = el.getAttribute("data-nom") || "";
            fillClient(code, nom);
          });
        });
      }

      async function fetchClients(q) {
        if (!q || q.length < 2) {
          clearResults();
          return;
        }
        lastQuery = q;

        try {
          const resp = await fetch(`/api/clients?q=${encodeURIComponent(q)}`);
          if (!resp.ok) {
            clearResults();
            return;
          }
          const data = await resp.json();
          if (searchInput.value.trim() === lastQuery) {
            renderResults(data);
          }
        } catch (e) {
          console.error("Erreur fetch /api/clients :", e);
          clearResults();
        }
      }

      searchInput.addEventListener("input", () => {
        const val = searchInput.value.trim();
        if (timerId) clearTimeout(timerId);
        timerId = setTimeout(() => fetchClients(val), 200);
      });

      // Si on envoie le formulaire sans avoir choisi un client dans la liste,
      // on prend ce qu'il a tap√© comme nom client (code_client restera vide).
      const form = searchInput.closest("form");
      if (form) {
        form.addEventListener("submit", () => {
          if (!nomInput.value && searchInput.value.trim()) {
            nomInput.value = searchInput.value.trim();
          }
        });
      }

      document.addEventListener("click", (evt) => {
        if (!resultsBox.contains(evt.target) && evt.target !== searchInput) {
          clearResults();
        }
      });
    })();
  </script>
</body>
</html>