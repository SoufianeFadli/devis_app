<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Devis SBBM - {{ ref_devis }}</title>
  <link rel="stylesheet" href="/static/style.css">
  <style>
    /* Cacher la barre utilisateur et les boutons d‚Äôaction dans le PDF */
    @media print {
      .user-bar,
      .actions-top {
        display: none !important;
      }
      .app-body {
        padding-top: 0 !important;
      }
    }
  </style>
</head>
<body class="app-body">
  {% if user_code_commercial %}
  <div class="user-bar">
    <div class="user-bar-left">
      Connect√© : <strong>{{ user_code_commercial }}</strong>
      {% if user_nom %} ({{ user_nom }}){% endif %}
    </div>
    <div class="user-bar-right">
      <a href="/logout" class="user-bar-link">D√©connexion</a>
    </div>
  </div>
  {% endif %}
  <!-- Bandeau d‚Äôactions (cach√© en PDF via CSS print) -->
  <div class="app-shell">
  <div class="actions-top">
    <a class="btn btn-secondary" href="/devis/form">üìù Nouveau devis</a>
    <a class="btn btn-primary" href="/pdf/{{ ref_devis }}" target="_blank">üìÑ Exporter en PDF</a>
  </div>

  <div class="page devis-page">

    <!-- ENT√äTE SOCI√âT√â -->
    <header class="header-pro">
      <div class="logo-box">
        <img src="{{ logo_data_uri or '/static/logo_sbbm.jpg' }}" alt="Logo SBBM" >
      </div>
      <div class="header-right">
        <div class="societe-nom">SOCI√âT√â DE B√ÇTIMENTS ET B√âTON MOUL√â ‚ÄúSBBM‚Äù</div>
        <div class="societe-addr">
          Lot 410 Sidi Ghanem Q.I Marrakech<br>
          T√©l : +212 5 24 33 54 48 &nbsp;&nbsp;‚Ä¢&nbsp;&nbsp; Email : sbbmdga@gmail.com
        </div>
        <div class="societe-extra">
          RC : 7683 &nbsp;&nbsp;‚Ä¢&nbsp;&nbsp; IF : 06501586 &nbsp;&nbsp;‚Ä¢&nbsp;&nbsp; ICE : 001541978000061
        </div>
      </div>
    </header>

    <!-- BANDEAU TITRE -->
    <section class="devis-banner">
      <div class="devis-title-main">
        DEVIS N¬∞ {{ ref_devis }}
      </div>
      <div class="devis-sub">
        Pour : <span class="strong">{{ client }}</span>
        &nbsp;‚Ä¢&nbsp; Chantier : <span class="strong">{{ chantier }}</span>
      </div>
      <div class="devis-meta">
        Date : {{ date_devis }} &nbsp;‚Ä¢&nbsp; Validit√© : {{ validite }}
      </div>
    </section>

    <!-- INFOS CLIENT / DEVIS -->
    <section class="info-grid">
      <div class="card card-info">
        <div class="card-title">INFORMATIONS CLIENT</div>
        <div class="info-table">
          <div class="row">
            <div class="lbl">Code client</div><div class="val">{{ code_client|default("") }}</div>
          </div>
          <div class="row">
            <div class="lbl">Client</div><div class="val">{{ client }}</div>
          </div>
          <div class="row">
            <div class="lbl">Adresse chantier</div><div class="val">{{ chantier }}</div>
          </div>
          <div class="row">
            <div class="lbl">Niveau</div><div class="val">{{ niveau|default("") }}</div>
          </div>
          <div class="row">
            <div class="lbl">N¬∞ affaire</div><div class="val">{{ affaire|default("") }}</div>
          </div>
        </div>
      </div>

      <div class="card card-info">
        <div class="card-title">PARAM√àTRES DU DEVIS</div>
        <div class="info-table">
          <div class="row">
            <div class="lbl">R√©f devis</div><div class="val">{{ ref_devis }}</div>
          </div>
          <div class="row">
            <div class="lbl">Mode livraison</div><div class="val">{{ mode_livraison }}</div>
          </div>
          <div class="row">
            <div class="lbl">Distance (km)</div><div class="val">{{ distance_km }}</div>
          </div>
          <div class="row">
            <div class="lbl">Mode transport</div>
            <div class="val">
              {% if mode_transport == "rendu" %}
                Rendu chantier
              {% else %}
                D√©part usine
              {% endif %}
            </div>
          </div>
          <div class="row">
            <div class="lbl">Commercial</div>
            <div class="val">
              {{ nom_commercial|default("") }}
              {% if code_commercial %}
                (Code : {{ code_commercial }})
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- √âVENTUEL R√âCAP TECHNIQUE -->
    {% if surface_ct or surface_ts %}
    <section class="card card-resume">
      <div class="card-title">R√âCAPITULATIF TECHNIQUE</div>
      <div class="info-table">
        {% if surface_ct %}
        <div class="row">
          <div class="lbl">Surface plancher (CT)</div>
          <div class="val">{{ "%.2f"|format(surface_ct) }} m¬≤</div>
        </div>
        {% endif %}
        {% if surface_ts %}
        <div class="row">
          <div class="lbl">Surface treillis soud√©s (TS)</div>
          <div class="val">{{ "%.2f"|format(surface_ts) }} m¬≤</div>
        </div>
        {% endif %}

        {% if transport_total_effectif is defined and transport_total_effectif > 0 %}
        <div class="row">
          <div class="lbl">Transport total appliqu√©</div>
          <div class="val strong">
            {{ "%.2f"|format(transport_total_effectif) }} DH
          </div>
        </div>
        {% endif %}
      </div>
    </section>
    {% endif %}

    <!-- TABLEAU PRODUITS -->
    <section class="table-wrap">
      <div class="section-title">D√âTAIL DES FOURNITURES</div>
      <table class="devis-table">
        <thead>
          <tr>
            <th class="col-type">D√©signation</th>
            <th>Longueur / Surface</th>
            <th>√âtriers</th>
            <th>Quantit√©</th>
            <th>Prix unitaire HT</th>
            <th>Total ligne HT</th>
          </tr>
        </thead>
        <tbody>
          {% for l in lignes %}
          <tr>
            <td class="col-type">
              {{ l.type }}
            </td>
            <td class="num">
              {{ l.longueur }}
            </td>
            <td class="num">
              {{ l.etrier }}
            </td>
            <td class="num">
              {{ l.nombre }}
            </td>
            <td class="num">
              {{ "%.3f"|format(l.prix) }}
            </td>
            <td class="num strong">
              {{ "%.2f"|format(l.total) }}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <!-- BLOC TOTAUX -->
      <div class="totaux-card">
        <div class="tot-row">
          <div class="label">TOTAL H.T.</div>
          <div class="value">{{ "%.2f"|format(total_ht) }} DH</div>
        </div>
        <div class="tot-row">
          <div class="label">T.V.A 20%</div>
          <div class="value">{{ "%.2f"|format(tva) }} DH</div>
        </div>
        <div class="tot-row tot-row-important">
          <div class="label">TOTAL T.T.C</div>
          <div class="value">{{ "%.2f"|format(total_ttc) }} DH</div>
        </div>
      </div>
    </section>

    <!-- COMMENTAIRE TRANSPORT -->
    {% if transport_commentaire %}
    <section class="card card-transport">
      <div class="card-title">TRANSPORT</div>
      <p>{{ transport_commentaire }}</p>
    </section>
    {% endif %}

    <!-- CONDITIONS & SIGNATURE -->
    <section class="conditions-signature">
      <div class="conditions">
        <div class="cond-title">CONDITIONS DU DEVIS</div>
        <ol>
          <li>Devis √©tabli sur la base des plans de b√©ton arm√© ou informations techniques fournis par le client.</li>
          <li>Toute modification ult√©rieure pourra donner lieu √† un devis compl√©mentaire.</li>
          <li>Les prix indiqu√©s sont exprim√©s en Dirhams H.T., TVA en sus.</li>
          <li>Validit√© de l‚Äôoffre : {{ validite }} √† compter de la date du devis.</li>
          <li>Le transport est calcul√© selon la distance usine - chantier et les charges maximales autoris√©es.</li>
        </ol>
      </div>

      <div class="signature-box">
        <div class="sig-title">Pour la Soci√©t√© de B√¢timents et B√©ton Moul√© ‚ÄúSBBM‚Äù</div>
        <div class="sig-zone">
          <div class="sig-label">Visa et cachet de la soci√©t√©</div>
          <div class="sig-space"></div>
        </div>
        <div class="sig-commercial">
          Commercial : {{ nom_commercial|default("") }}
          {% if code_commercial %}(Code : {{ code_commercial }}){% endif %}
        </div>
      </div>
    </section>

  </div>
</body>
</html>